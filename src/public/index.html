<html>
    <head>
        <title>Download Stream Example</title>
    </head>
    <body>
        <h1>Download Stream Example</h1>
        <hr>

        <p>
            <button onclick="run()">Fetch CSV data</button>
        </p>
        <p>Chunks: <span id="chunkCount"></span></p>
        <p>Lines: <span id="lines"></span></p>
        
        <script type="text/javascript">

            var chunkCount = 0;
            var data = [];

            function render() {
                document.getElementById('chunkCount').textContent = chunkCount;
                document.getElementById('lines').textContent = data.length;
            }

            var rest = [];

            function parseCSVLine(line) {
                var cols = line.split(';');
                return cols.map(c => c.substr(1, c.length - 2));
            }

            function run() {
                fetch('/csv-generator')
                    .then(r => {
                        const reader = r.body.getReader();
                        reader.read().then(function processText({ done, value }) {
                            if(done) {
                                console.log('Done!')
                                return;
                            }
                            chunkCount++;

                            var restLength = 0;
                            if (rest) {
                                restLength = rest.length;
                            }
                            var chunk = new Uint8Array(rest.length + value.length);
                            if (rest) {
                                chunk.set(rest);
                            }
                            chunk.set(value, restLength);

                            rest = '';
                            var done = false;
                            var item = [];

                            for(var i = 0; i < chunk.length; i++) {
                                var charCode = chunk[i];
                                if (charCode === 10) {
                                    data.push(parseCSVLine(item.map(c => String.fromCharCode(c)).join('')));
                                    item = [];
                                } else {
                                    item.push(charCode);
                                }
                            }
                            rest = item;

                            render();

                            return reader.read().then(processText);
                        });
                    });
            }

        </script>

    </body>
</html>
